# Восстановление золота из руды
## Цель работы
Подготовка прототипа модели машинного обучения для компании «Цифры», которая разрабатывает решения для эффективной работы промышленных предприятий.
Используя данные с параметрами добычи и очистки, модель должна предсказать коэффициент восстановления золота из золотосодержащей руды. Модель поможет оптимизировать производство, чтобы не запускать предприятие с убыточными характеристиками.
## Описание данных
* **Технологический процесс**
    + Rougher feed — исходное сырье
    + Rougher additions (или reagent additions) — флотационные реагенты: Xanthate, Sulphate, Depressant
    + Xanthate — ксантогенат (промотер, или активатор флотации);
    + Sulphate — сульфат (на данном производстве сульфид натрия);
    + Depressant — депрессант (силикат натрия).
    + Rougher process (англ. «грубый процесс») — флотация
    + Rougher tails — отвальные хвосты
    + Float banks — флотационная установка
    + Cleaner process — очистка
    + Rougher Au — черновой концентрат золота
    + Final Au — финальный концентрат золота
* **Параметры этапов**
    + air amount — объём воздуха
    + fluid levels — уровень жидкости
    + feed size — размер гранул сырья
    + feed rate — скорость подачи
* **Наименование признаков**
    - Наименование признаков должно быть такое: <br>
        [этап].[тип_параметра].[название_параметра]<br>
        Пример: rougher.input.feed_ag
    - Возможные значения для блока [этап]:
        + rougher — флотация
        + primary_cleaner — первичная очистка
        + secondary_cleaner — вторичная очистка
        + final — финальные характеристики
    - Возможные значения для блока [тип_параметра]:
        + input — параметры сырья
        + output — параметры продукта
        + state — параметры, характеризующие текущее состояние этапа
        + calculation — расчётные характеристики
## Необходимые формулы
Метрика качества:
![smape](https://pictures.s3.yandex.net/resources/smape_1576239058.jpg)
где:
+ **y<sub>i</sub>** - значение целевого признака для объекта с порядковым номером *i* в выборке, на которой измеряется качество
+ **&#375;<sub>i</sub>** - значение предсказания для объекта с порядковым номером *i*, например, в тестовой выборке
+ **N** - количество объектов в выборке.
  
Итоговая метрика:  
![final_smape](https://pictures.s3.yandex.net/resources/_smape_1576239054.jpg)
Эффективность обогащения:
![recovery](https://pictures.s3.yandex.net/resources/Recovery_1576238822.jpg)
где:
* C — доля золота в концентрате после флотации/очистки;
* F — доля золота в сырье/концентрате до флотации/очистки;
* T — доля золота в отвальных хвостах после флотации/очистки.
## План работ
1. **Подготовка данных**
    + 1.1 Открыть файлы и изучить их.<br>
        Путь к файлам:<br>
        - /datasets/gold_industry_train.csv 
        - /datasets/gold_industry_test.csv
        - /datasets/gold_industry_full.csv
    + 1.2. Проверить, что эффективность обогащения рассчитана правильно. Вычислить её на обучающей выборке для признака `rougher.output.recovery`. Найти MAE между нашими расчётами и значением признака. Описать выводы.
    + 1.3. Проанализировать признаки, недоступные в тестовой выборке. Что это за параметры? К какому типу относятся?
    + 1.4. Провести предобработку данных.
2. **Проанализировать данные**
    + 2.1. Посмотреть, как меняется концентрация металлов (Au, Ag, Pb) на различных этапах: в сырье, в черновом концентрате, в концентрате после первой очистки и в финальном концентрате. Какие особенности имеют распределения? Описать выводы.
    + 2.2.  Сравнить распределения размеров гранул исходного сырья на обучающей и тестовой выборках. Если распределения сильно отличаются друг от друга, оценка модели будет неправильной.
    + 2.3. Исследовать суммарную концентрацию металлов на разных стадиях: в сырье, в черновом концентрате, в концентрате после первой очистки и в финальном концентрате.
3. **Построить модель**
    + 3.1. Написать функцию для вычисления итоговой sMAPE.
    + 3.2. Обучить разные модели и оцените их качество кросс-валидацией. Выбрать лучшую модель и проверить её на тестовой выборке. Описать выводы.
## Итоговой вывод
   Были проведена работа и получены следующие итоги:
1. Подготовка данных 
    - Загрузили и изучили данные. Обнаружили следующие проблемы:
        + Наличие пропусков в столбцах
        + Колонка date имеет неверный тип данных (object), требуется datetime64
        + Количество колонок в тестовой таблице test_df (53) не соответствует количеству колонок в таблицах full_df и train_df (87)
    - Вычислили эффективность обогащения на обучающей выборке, затем проверили с помощью метрики MAE вычисленные значения с приведенными в таблице. Результат показал, что приведенные в таблице данные корректны. На них можно обучаться.
    - Выяснили, какие признаки недоступны в тестовой выборке.
    - Провели предобработку данных:
        + Поменяли тип данных у колонок date на datetime64
        + Проверили наличие дубликатов строк. Их не оказалось
        + С помощью метода ffillna заполнили пропуски во всех колонках
2. Анализ данных:
    - Рассмотрели, как меняется концентрация металлов (Au, Ag, Pb) на различных этапах: в сырье, в черновом концентрате, в концентрате после первой очистки и в финальном концентрате. Получили следующие итоги:
        + Серебро Ag: Концентрация уменьшается в процессе очистки. Финальная концентрация равна 0.5%. Максимальная концентрация (12%) — после флотации.
        + Свинец Pb: Концентрация на каждом этапе растет (с 0.5% до 10%)
        + Золото Au: Концентрация линейно растет (от 1% до 45%)
    - Установили, что распределения размеров гранул исходного сырья на обучающей и тестовой выборках отличаются слабо
    - Посчитали суммарную концентрацию металлов на разных стадиях обработки. Выяснили, что есть выбросы значений близкие к 0, избавились от этих выбросов в датафрейме с суммарными концентрациями и от соответствующих данных в датафреймах с остальными параметрами (обучающая, тестовая).
3. Модель для предсказания эффективности обогащения:
    - Реализовали функцию для вычисления итоговой метрики sMAPE 
    - Подготовили данные для обучения моделей
    - Обучили три типа модели: Линейная регрессия, Случайный лес, Решающее дерево
    - Выяснили, что лучшее значение метрики итоговой sMAPE (**8.20%**) показывает модель **Случайный лес**
    - Протестировали лучшую модель на тестовой выборке, получили значение **7.37 %**
    - Также убедились в адекватности полученного значения
